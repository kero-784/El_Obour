<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Manager</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Styles remain the same as before - no changes needed for scanning UI in CSS for now */
        body, html { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background-color: #f3f3f3; color: #212121; line-height: 1.5; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        #currentDateDisplay { position: fixed; top: 16px; right: 16px; font-size: 0.85em; color: #757575; }
        .container { max-width: 960px; margin: 20px auto; padding: 24px; }
        h1 { text-align: center; color: #3F51B5; margin-bottom: 24px; font-size: 2rem; font-family: 'Roboto Condensed', sans-serif; font-weight: 700; }
        .database-section-container { background-color: #fff; border-radius: 4px; padding: 24px; margin-bottom: 16px; box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 3px 1px -2px rgba(0,0,0,0.12), 0 1px 5px 0 rgba(0,0,0,0.2); }
        .database-section-container h2 { font-size: 1.3rem; color: #212121; margin-top: 0; margin-bottom: 16px; font-weight: 500; font-family: 'Roboto Condensed', sans-serif; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; }
        button { padding: 10px 16px; margin: 4px; cursor: pointer; border: none; border-radius: 4px; color: white; background-color: #3F51B5; font-size: 0.9rem; text-transform: uppercase; box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 3px 1px -2px rgba(0,0,0,0.12), 0 1px 5px 0 rgba(0,0,0,0.2); transition: box-shadow 0.3s ease, background-color 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:hover { box-shadow: 0 4px 5px 0 rgba(0,0,0,0.25), 0 1px 10px 0 rgba(0,0,0,0.22), 0 2px 4px -1px rgba(0,0,0,0.3); background-color: #303F9F; }
        button:focus { outline: none; box-shadow: 0 0 0 2px rgba(159, 168, 218, 0.5); }
        .secondary-button { background-color: transparent; color: #757575; box-shadow: none; font-size: 0.85rem; padding: 6px 12px; }
        .secondary-button:hover { background-color: rgba(159, 168, 218, 0.1); color: #3F51B5; box-shadow: none; }
        .secondary-button:focus { box-shadow: 0 0 0 2px rgba(159, 168, 218, 0.3); }
        .remove-button { background-color: #F44336; } .remove-button:hover { background-color: #D32F2F; }
        .add-expiry-button-inline { background-color: #FFC107; color: #212121; } .add-expiry-button-inline:hover { background-color: #FFB300; }
        .save-expiry-button { background-color: #4CAF50; } .save-expiry-button:hover { background-color: #388E3C; }
        .material-icons { vertical-align: middle; }
        input[type="text"], input[type="number"] { padding: 12px; margin: 4px; border: 1px solid #BDBDBD; border-radius: 4px; font-size: 0.9rem; outline: none; box-shadow: none; }
        input[type="text"]:focus, input[type="number"]:focus { border-color: #3F51B5; box-shadow: 0 0 0 1px #3F51B5; }
        input[type="file"] { margin-bottom: 16px; font-size: 0.9rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 16px; background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); border-radius: 4px; overflow: hidden; border: 1px solid #e0e0e0; }
        th, td { padding: 12px; text-align: left; font-size: 0.85rem; white-space: nowrap; border-bottom: 1px solid #e0e0e0; }
        th { background-color: #f5f5f5; color: #757575; font-weight: 500; text-transform: uppercase; letter-spacing: 0.03em; }
        tr:nth-child(even) td { background-color: #f9f9f9; } tr:last-child td { border-bottom: none; }
        .expiry-input-group { display: flex; align-items: center; margin-bottom: 12px; gap: 8px; }
        #dataPopup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000; overflow: auto; }
        #dataPopupContent { background-color: #fff; padding: 32px; border-radius: 4px; box-shadow: 0 9px 46px rgba(0, 0, 0, 0.12), 0 11px 15px -7px rgba(0, 0, 0, 0.2); max-height: 90vh; max-width: 90vw; position: relative; }
        .closePopup { position: absolute; top: 12px; right: 16px; font-size: 24px; cursor: pointer; color: #757575; transition: color 0.3s ease; }
        .closePopup:hover { color: #212121; } #popupTable th { background-color: #f0f0f0; }
        #searchResultTable { display: none; margin-top: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); border-radius: 4px; background-color: white; overflow: hidden; border: 1px solid #e0e0e0; }
        #searchResultTable th, #searchResultTable td { padding: 12px; white-space: nowrap; } #searchResultTable th { background-color: #f5f5f5; }
        #searchResultTable tr:nth-child(even) td { background-color: #f9f9f9; } #searchResultTable tr:last-child td { border-bottom: none; }
        @media (max-width: 768px) { .container { padding: 16px; margin: 16px auto; } h1 { font-size: 1.8rem; margin-bottom: 16px; } .database-section-container { padding: 16px; margin-bottom: 12px; } .database-section-container h2 { font-size: 1.2rem; margin-bottom: 12px; } button, input[type="text"], input[type="number"] { padding: 8px 12px; font-size: 0.85rem; } th, td { padding: 10px; font-size: 0.8rem; } #currentDateDisplay { top: 12px; right: 12px; font-size: 0.8em; } .expiry-input-group { flex-direction: column; align-items: stretch; gap: 8px; } button { font-size: 0.85rem; padding: 8px 12px; } .secondary-button { font-size: 0.8rem; padding: 5px 10px; } }
        @media (max-width: 576px) { h1 { font-size: 1.5rem; margin-bottom: 12px; } .database-section-container h2 { font-size: 1.1rem; margin-bottom: 10px; } button, input[type="text"], input[type="number"] { padding: 7px 10px; font-size: 0.8rem; margin: 3px; } th, td { padding: 8px; font-size: 0.75rem; } #currentDateDisplay { top: 8px; right: 8px; font-size: 0.75em; } .container { padding: 12px; margin: 12px auto; } }

        /* New styles for camera preview and scan button */
        #cameraPreview {
            display: none; /* Hidden by default */
            max-width: 320px; /* Adjust as needed */
            max-height: 240px;
            margin: 16px auto;
            border: 1px solid #ccc;
        }
        #scanBarcodeButton {
            margin-top: 10px; /* Add some space above the button */
        }

    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics-compat.js"></script>
    <!-- QuaggaJS Library -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</head>
<body>
    <div id="currentDateDisplay"></div>
    <div class="container">
        <h1>Inventory Manager</h1>

        <section class="database-section-container">
            <h2>Database Management</h2>
            <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
            <button id="importButton" disabled title="Import from Excel is disabled in this version, data loads automatically from Google Sheet"><span class="material-icons">file_upload</span>Import Data (Disabled)</button>
            <button id="viewDataButton" class="secondary-button" disabled><span class="material-icons">visibility</span>View Data</button>
            <button id="clearDatabaseButton" class="secondary-button" disabled><span class="material-icons">delete_sweep</span>Clear DB</button>
            <button id="exportButton" class="secondary-button" disabled><span class="material-icons">file_download</span>Export Data</button>
        </section>

        <section class="database-section-container">
            <h2>Search Inventory</h2>
            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 20px;">
                <input type="text" id="searchBarcodeInput" placeholder="Enter Barcode to Search">
                <button id="searchButton" disabled><span class="material-icons">search</span>Search</button>
                <!-- New "Scan Barcode" Button -->
                <button id="scanBarcodeButton" type="button"><span class="material-icons">camera_alt</span>Scan Barcode</button>
            </div>
             <!-- Video element for camera preview (initially hidden) -->
            <video id="cameraPreview"></video>
            <table id="searchResultTable">
                <thead></thead>
                <tbody id="searchResultTableBody"></tbody>
              </table>
        </section>

        <section class="database-section-container">
            <h2>Record Entry</h2>
            <div style="margin-bottom: 16px;">
                <button id="addExpiryButton"><span class="material-icons">add</span>Add Expiry</button>
                <button id="clearFieldsButton" class="secondary-button"><span class="material-icons">clear_all</span>Clear Fields</button>
            </div>

            <div id="expiryInputs">
                <!-- Dynamic Expiry Inputs will be placed here -->
            </div>

            <button id="saveButton" disabled class="save-expiry-button"><span class="material-icons">save</span>Save Entry</button>
        </section>

        <section class="database-section-container">
            <h2>Inventory Records</h2>
            <table id="recordTable">
                <thead></thead>
                <tbody id="recordTableBody"></tbody>
            </table>
        </section>

        <div id="dataPopup" style="display:none">
            <div id="dataPopupContent">
             <span class="closePopup">×</span>
             <table id="popupTable"></table>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script>
         // Firebase configuration - same as before
        const firebaseConfig = { apiKey: "AIzaSyAqB5syqP1BVfA9dUx3A6zvokDw3oacy_E", authDomain: "data-base-2c8bf.firebaseapp.com", projectId: "data-base-2c8bf", storageBucket: "data-base-2c8bf.firebasestorage.app", messagingSenderId: "958395018379", appId: "1:958395018379:web:53c32ddb4941f3545a788e", measurementId: "G-77TNX586M4" };
        firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics();

         // Google Sheet CSV URL - same as before
        const googleSheetCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQNrRFFRPe_jrOrDZM58gRqxfsA0deD60_q2jkA7XJRRfJQ7IiBdIqNDN7JdMawjw/pub?output=csv";

         // Global variables - same as before
        let database = [];
        let currentItem = null;
        let enteredRecords = [];
        let headerMap = {};
        let barcodeHeader = '';
        let nameHeader = '';
        let expiryHeaderCount = 0;

        // Get HTML elements - added scanBarcodeButton and cameraPreview
        const fileInput = document.getElementById('fileInput');
        const importButton = document.getElementById('importButton');
        const searchBarcodeInput = document.getElementById('searchBarcodeInput');
        const searchButton = document.getElementById('searchButton');
        const searchResultTable = document.getElementById('searchResultTable');
        const searchResultTableBody = document.getElementById('searchResultTableBody');
        const expiryInputs = document.getElementById('expiryInputs');
        const addExpiryButton = document.getElementById('addExpiryButton');
        const saveButton = document.getElementById('saveButton');
        const clearFieldsButton = document.getElementById('clearFieldsButton');
        const recordTableBody = document.getElementById('recordTableBody');
        const exportButton = document.getElementById('exportButton');
        const viewDataButton = document.getElementById('viewDataButton');
        const clearDatabaseButton = document.getElementById('clearDatabaseButton');
        const dataPopup = document.getElementById('dataPopup');
        const dataPopupContent = document.getElementById('dataPopupContent');
        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const closePopup = document.querySelector('.closePopup');
        const scanBarcodeButton = document.getElementById('scanBarcodeButton'); // New button
        const cameraPreview = document.getElementById('cameraPreview');         // New video element

        function getCurrentDateTime(){ /* ... same as before ... */ return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;}
        function loadDataFromLocalStorage() { /* ... same as before with try-catch for headerMap ... */  /* ... loadDataFromLocalStorage function - same as before, with error handling for headerMap ... */
            const storedEnteredRecords = localStorage.getItem('enteredRecords');
            const storedHeaderMap = localStorage.getItem('headerMap');
            const storedBarcodeHeader = localStorage.getItem('barcodeHeader');
            const storedNameHeader = localStorage.getItem('nameHeader');
            let storedCurrentDate = localStorage.getItem('currentDate');

            if (storedEnteredRecords) enteredRecords = JSON.parse(storedEnteredRecords);

            if (storedHeaderMap) {
                try {
                    headerMap = JSON.parse(storedHeaderMap);
                } catch (e) {
                    console.warn("Error parsing stored headerMap from localStorage. Resetting headerMap to empty object.", e);
                    headerMap = {};
                }
            } else {
                headerMap = {};
            }

            if (storedBarcodeHeader) barcodeHeader = storedBarcodeHeader;
            if(storedNameHeader) nameHeader = storedNameHeader;
            if(!storedCurrentDate){
                localStorage.setItem('currentDate', getCurrentDateTime());
                storedCurrentDate = localStorage.getItem('currentDate')
            }

            currentDateDisplay.textContent = `Current Date: ${storedCurrentDate}`;
            renderEnteredRecords();
            console.log("Attempted to load data from Local Storage (Entered Records & Settings).");
        }
        function parseCSV(csvText) { /* ... same as before ... */ /* ... parseCSV function - same as before ... */
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(header => header.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const currentLine = lines[i].split(',').map(cell => cell.trim());
                const item = {};
                for (let j = 0; j < headers.length; j++) {
                    item[headers[j]] = currentLine[j];
                }
                data.push(item);
            }
            return { headers, data };
        }
        async function fetchDataFromGoogleSheet() { /* ... same as before ... */ /* ... fetchDataFromGoogleSheet function - same as before ... */
            console.log("Fetching data from Google Sheet...");
            try {
                const response = await fetch(googleSheetCsvUrl);
                if (!response.ok) {
                    console.error(`HTTP error! status: ${response.status}, statusText: ${response.statusText}`);
                    alert(`Failed to fetch updated data from Google Sheet. HTTP error! Status: ${response.status} ${response.statusText}. Inventory data will be loaded only when fetched successfully. Please check console for details.`);
                    return null;
                }
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                console.log("Data fetched and parsed from Google Sheet successfully.");
                return parsedData;
            } catch (error) {
                console.error("Error fetching data from Google Sheet:", error);
                alert('Failed to load inventory data from Google Sheet due to a network error or issue parsing data. Inventory data will be loaded only when fetched successfully. Please check console for details.');
                return null;
            }
        }
        async function initializeData() { /* ... same as before ... */ /* ... initializeData function - same as before ... */
            loadDataFromLocalStorage();

            const googleSheetData = await fetchDataFromGoogleSheet();

            if (googleSheetData) {
                const { headers, data } = googleSheetData;

                headers.forEach((header, index) => {
                    if(header && header.toLowerCase().includes('barcode')) {
                      barcodeHeader = header;
                    }
                    if(header && header.toLowerCase().includes('name')){
                      nameHeader = header;
                    }
                     headerMap[header] = index;
                });

                 if (!barcodeHeader) {
                     alert("No 'barcode' column found in the Google Sheet data. Please ensure your Google Sheet has a column header that includes 'barcode'. Inventory data loading failed.");
                     return;
                 }
                 if (!nameHeader){
                     alert("No 'name' column found in the Google Sheet data. Please ensure your Google Sheet has a column header that includes 'name'. Inventory data loading failed.");
                     return;
                 }

                database = data.map(item => headers.map(header => item[header]));
                 localStorage.setItem('headerMap', JSON.stringify(headerMap));
                 localStorage.setItem('barcodeHeader', barcodeHeader);
                  localStorage.setItem('nameHeader', nameHeader);

                alert('Inventory data updated successfully from Google Sheets!');
                 renderEnteredRecords();
               viewDataButton.disabled = false;
               searchButton.disabled = false;
               clearDatabaseButton.disabled = false;
               exportButton.disabled = false;
               console.log("Inventory data initialized/updated from Google Sheet.");
            } else {
                console.warn("Failed to update data from Google Sheet. Inventory functions are disabled until data is loaded.");
                alert("Failed to load inventory data from Google Sheets. Inventory functions are disabled until data is loaded. Please check console for errors and refresh the page to try again.");

                    viewDataButton.disabled = true;
                    searchButton.disabled = true;
                    clearDatabaseButton.disabled = true;
                    exportButton.disabled = true;
            }
        }

        initializeData();
        importButton.addEventListener('click', () => { alert("Import from Excel file is disabled in this version. Data is automatically loaded from Google Sheet."); });
        fileInput.addEventListener('change', handleFileImport);
        async function handleFileImport(event) { alert("Import from Excel file is disabled in this version. Data is automatically loaded from Google Sheet."); return; }
        searchButton.addEventListener('click', () => { /* ... same as before ... */ /* ... searchButton click listener - same as before ... */
            const barcode = searchBarcodeInput.value.trim();

            if(!barcode){
                alert('Please enter a barcode to search!')
                return;
            }
            if(database.length === 0){
                alert('Inventory data is still loading from Google Sheets or failed to load. Please wait or refresh the page.');
                return;
            }

            const foundItem = database.find(item => {
                const barcodeValue = item[headerMap[barcodeHeader]];
                return barcodeValue && barcodeValue.toString() === barcode;
            });

            if (foundItem) {
              currentItem = foundItem;
                 renderSearchResultTable(foundItem);
                addExpiryEntry();
                saveButton.disabled = false;
            } else {
               alert("No item found with this barcode!")
              currentItem = null;
                searchResultTable.style.display = 'none';
              expiryInputs.innerHTML = '';
              saveButton.disabled = true;
            }
        });
        function renderSearchResultTable(foundItem) { /* ... same as before ... */ /* ... renderSearchResultTable function - same as before ... */
           const searchResultTableHead = searchResultTable.querySelector('thead');
           searchResultTableHead.innerHTML = '';
           const headerRow = document.createElement('tr');
          for (const header in headerMap) {
           const th = document.createElement('th');
           th.textContent = header;
           headerRow.appendChild(th);
          }
           searchResultTableHead.appendChild(headerRow)

             searchResultTableBody.innerHTML = '';

               const row = document.createElement('tr');
             for (const header in headerMap) {
               const td = document.createElement('td');
               td.textContent = foundItem[headerMap[header]];
               row.appendChild(td)
              }

             searchResultTableBody.appendChild(row);
           searchResultTable.style.display = 'block';
        }
        addExpiryButton.addEventListener('click', addExpiryEntry);
        function addExpiryEntry() { /* ... same as before ... */ /* ... addExpiryEntry function - same as before ... */
            const entryDiv = document.createElement('div');
            entryDiv.classList.add('expiry-input-group');
            const dateInput = document.createElement('input');
            dateInput.type = 'text';
            dateInput.placeholder = 'Expiry Date (dd/mm/yyyy)';
           dateInput.addEventListener('input', (e) => { /* ... date input formatting ... */
              let value = e.target.value.replace(/[^0-9]/g, '');
                 if (value.length > 8){ value = value.substring(0, 8); }
                if (value.length > 2) { value = value.substring(0,2) + "/" + value.substring(2); }
               if (value.length > 5) { value = value.substring(0, 5) + "/" + value.substring(5); }
              e.target.value = value;
            });
             dateInput.addEventListener('blur', (e) =>{ /* ... date validation ... */
                if(!isValidDate(e.target.value)){
                   alert('Invalid date, Please use correct dd/mm/yyyy format, Ensure that the date is not in the past or too far into the future!');
                   e.target.value = '';
                }
            });

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.placeholder = 'Quantity';
            quantityInput.min = '1';
            const removeButton = document.createElement('button');
            removeButton.textContent = 'Remove';
            removeButton.classList.add('remove-button');
            removeButton.addEventListener('click', () => { entryDiv.remove(); });
            const addExpiryForButton = document.createElement('button');
            addExpiryForButton.textContent = 'Add Expiry';
            addExpiryForButton.classList.add('add-expiry-button-inline');
            addExpiryForButton.addEventListener('click', () => { addExpiryEntry(); });
            entryDiv.appendChild(dateInput);
            entryDiv.appendChild(quantityInput);
            entryDiv.appendChild(removeButton);
            entryDiv.appendChild(addExpiryForButton);
            expiryInputs.appendChild(entryDiv);
        }
          function isValidDate(dateString){ /* ... same as before ... */ /* ... isValidDate function - same as before ... */
          if(!/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) { return false; }
           const [day, month, year] = dateString.split('/').map(Number);
          const date = new Date(year, month-1, day);
           if (date.getDate() !== day || date.getMonth() + 1 !== month || date.getFullYear() !== year) { return false; }
             const currentDate = new Date();
             const futureDate = new Date();
              futureDate.setFullYear(currentDate.getFullYear() + 5);
           if (date.getTime() < currentDate.getTime()) { return false; }
          if (date.getTime() > futureDate.getTime()) { return false; }
            if(date.getTime() === currentDate.getTime()){ return false;}
          return true;
        }
        saveButton.addEventListener('click', () => { /* ... same as before ... */ /* ... saveButton click listener - same as before ... */
             if(!currentItem){ alert("Please search for an item to save!"); return; }
           const expiryEntries = expiryInputs.querySelectorAll('.expiry-input-group');
           if (expiryEntries.length === 0) { alert('Please add at least one expiry entry!'); return; }
             const itemData = {};
             for(const header in headerMap) { itemData[header] = currentItem[headerMap[header]]; }
             const existingRecordIndex = enteredRecords.findIndex(record => record[barcodeHeader] === itemData[barcodeHeader]);
           let record = existingRecordIndex === -1 ? {...itemData} : enteredRecords[existingRecordIndex]
          let count = 1;
          if(existingRecordIndex !== -1){ for(let i = 1; ; i++) { const expiryDateKey = `expiryDate${i}`; if (record.hasOwnProperty(expiryDateKey)){ count++; }else { break; } } }
              const saveTime = getCurrentDateTime();
          record[`recordTime`] = saveTime;
        expiryEntries.forEach(entryDiv =>{
            const dateInput = entryDiv.querySelector('input[type="text"]');
            const quantityInput = entryDiv.querySelector('input[type="number"]');
            if(!dateInput.value || !quantityInput.value){ alert("Please ensure you have filled out all date and quantity entries!"); return; }
               record[`expiryDate${count}`] = dateInput.value;
               record[`quantity${count}`] = parseInt(quantityInput.value, 10);
             count++;
           });
           if (existingRecordIndex === -1){ enteredRecords.push(record); }
            localStorage.setItem('enteredRecords', JSON.stringify(enteredRecords));
             renderEnteredRecords();
             clearFields();
            searchBarcodeInput.value = '';
              searchResultTable.style.display = 'none';
          });
        clearFieldsButton.addEventListener('click', clearFields);
        function clearFields() { expiryInputs.innerHTML = ''; }
        clearDatabaseButton.addEventListener('click', clearDatabase);
          function clearDatabase() { /* ... same as before ... */ /* ... clearDatabase function - same as before ... */
           if(confirm("Are you sure you want to clear the entire database? This action cannot be undone.")){
               database = [];
               currentItem = null;
               enteredRecords = [];
               headerMap = {};
               barcodeHeader = '';
               nameHeader = '';
               expiryHeaderCount = 0;
               recordTableBody.innerHTML = '';
               searchBarcodeInput.value = '';
               clearFields();
               saveButton.disabled = true;
               viewDataButton.disabled = true;
               searchButton.disabled = true;
               clearDatabaseButton.disabled = true;
               exportButton.disabled = true;
               searchResultTable.style.display = 'none';
               localStorage.clear();
             alert("Database has been cleared successfully!");
           } else { alert("Clear database operation cancelled."); }
       }
        function renderItemList() { /* ... same as before ... */ }
           function renderEnteredRecords() { /* ... same as before ... */ /* ... renderEnteredRecords function - same as before ... */
            const tableHead = recordTable.querySelector('thead');
                const tableBody = recordTable.querySelector('tbody');
                tableHead.innerHTML = '';
                tableBody.innerHTML = '';
                 const allHeaders = new Set();
                enteredRecords.forEach(record => { for (const key in record) { allHeaders.add(key); } });
                  const headerRow = document.createElement('tr');
                   allHeaders.forEach(header => { const headerCell = document.createElement('th'); headerCell.textContent = header; headerRow.appendChild(headerCell); });
                  const recordTimeHeader = document.createElement('th');
                  recordTimeHeader.textContent = "Recording Time";
                  headerRow.appendChild(recordTimeHeader);
                 tableHead.appendChild(headerRow)
              enteredRecords.forEach(record => {
                  const row = document.createElement('tr');
                  allHeaders.forEach(key => { const cell = document.createElement('td'); cell.textContent = record[key] || ''; row.appendChild(cell); });
                   const recordTimeCell = document.createElement('td');
                    recordTimeCell.textContent = record.recordTime || '';
                     row.appendChild(recordTimeCell);
                   tableBody.appendChild(row);
           });
         }
        function renderDataList(){ /* ... same as before ... */ /* ... renderDataList function - same as before ... */
             if(database.length === 0) { alert("Inventory data is still loading from Google Sheets. Please wait a moment and try again."); return; }
             const popupTable = document.getElementById('popupTable');
            popupTable.innerHTML = '';
            const headers = Object.keys(headerMap);
            const headerRow = document.createElement('tr');
            headers.forEach(headerText => { const th = document.createElement('th'); th.textContent = headerText; headerRow.appendChild(th); });
            popupTable.appendChild(headerRow);
            database.forEach(row => {
              const tr = document.createElement('tr');
              for (const header in headerMap) { const td = document.createElement('td'); td.textContent = row[headerMap[header]]; tr.appendChild(td); }
              popupTable.appendChild(tr);
            });
            dataPopup.style.display = 'flex';
        }
        exportButton.addEventListener('click', () => { /* ... same as before ... */ /* ... exportButton click listener - same as before ... */
            if (enteredRecords.length === 0) { alert('No records to export!'); return; }
            if(confirm("Export inventory records to XLSX file and clear entered records?")){
                try {
                    alert("Exporting inventory records, please wait...");
                    const worksheet = XLSX.utils.json_to_sheet(enteredRecords);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Inventory Records');
                    XLSX.writeFile(workbook, 'inventory_records.xlsx');
                    enteredRecords = [];
                   localStorage.setItem('enteredRecords', JSON.stringify(enteredRecords));
                    renderEnteredRecords();
                    alert('Data exported successfully and entered records cleared!');
                } catch (error) {
                    console.error("Error during export:", error);
                    alert('An error occurred while exporting the data. Please check console for details.');
                }
            } else { alert("Export operation cancelled."); }
        });
       viewDataButton.addEventListener('click', () =>{ renderDataList(); });
        closePopup.addEventListener('click', () => { dataPopup.style.display = 'none'; });
          window.addEventListener('click', (event) => { if (event.target === dataPopup) { dataPopup.style.display = 'none'; } });
        searchBarcodeInput.addEventListener('keydown', function(event) { if (event.key === 'Enter') { event.preventDefault(); searchButton.click(); } });
        window.addEventListener('load', function() { searchBarcodeInput.focus(); });

        // --- Barcode Scanning Functionality ---
        scanBarcodeButton.addEventListener('click', function() {
            // Disable search button and focus input while scanning
            searchButton.disabled = true;
            searchBarcodeInput.disabled = true;
            searchBarcodeInput.blur(); // Remove focus from input

            // Start QuaggaJS or resume if already initialized
            if (Quagga.initialized) {
                Quagga.start();
                cameraPreview.style.display = 'block'; // Show camera preview
            } else {
                startLiveScanning();
            }
        });

        function startLiveScanning() {
            Quagga.init({
                inputStream: {
                    name: "liveStream",
                    type: "LiveStream",
                    target: cameraPreview,
                    constraints: {
                        facingMode: "environment", // Attempt to get the rear camera
                        width: { ideal: 1280 },  // Ideal width for better resolution
                        height: { ideal: 720 }, // Ideal height
                        aspectRatio: { ideal: 16/9 } // Ideal aspect ratio
                    },
                    area: { // Define a smaller scanning area for focus (optional, adjust as needed)
                        top: "20%",    // Top boundary of the detection area
                        right: "20%",  // Right boundary
                        left: "20%",   // Left boundary
                        bottom: "20%"  // Bottom boundary
                    },
                    retry: true,            // Retry if stream fails
                    frequency: 10          // Check stream every 10ms
                },
                decoder: {
                    readers: [ "ean_reader", "code_128_reader", "code_39_reader", "upc_reader", "upc_e_reader" ]
                },
                locator: {
                    halfSample: true,
                    patchSize: "medium"
                    // --- Optional: More aggressive locator settings (if needed) ---
                    // halfSample: false,
                    // patchSize: "large",
                    // debug: {
                    //     showCanvas: false,
                    //     showPatches: false,
                    //     showFoundPatches: false,
                    //     showSkeleton: false,
                    //     showLabels: false,
                    //     showPatchLabels: false,
                    //     showRemainingPatchLabels: false,
                    //     box: false,
                    //     boxes: false,
                    //     patches: false,
                    //     singleChannel: false
                    // }
                }
            }, function(err) {
                if (err) {
                    console.error("QuaggaJS initialization error:", err);
                    alert("Failed to initialize barcode scanner: " + err.message + ". Please ensure you have camera permissions enabled for this site and try again.");
                    // Re-enable buttons and input on error
                    searchButton.disabled = false;
                    searchBarcodeInput.disabled = false;
                    cameraPreview.style.display = 'none'; // Ensure camera preview is hidden
                    return;
                }
                Quagga.initialized = true;
                Quagga.start();
                cameraPreview.style.display = 'block';
            });
        }

        Quagga.onDetected(function(data){
            Quagga.stop();                  // Stop scanning after detection
            cameraPreview.style.display = 'none'; // Hide camera preview
            searchBarcodeInput.value = data.codeResult.code; // Populate input
            searchButton.click();           // Trigger search

            // Re-enable search button and input after scan (even if search fails or no item found)
            searchButton.disabled = false;
            searchBarcodeInput.disabled = false;
            searchBarcodeInput.focus(); // Refocus input for next scan or manual entry
        });

        Quagga.onProcessed(function(result) {
            var drawingCtx = Quagga.canvas.ctx.overlay;
            var drawingCanvas = Quagga.canvas.overlay;

            if (result) {
                if (result.boxes) {
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                    result.boxes.filter(function (box) {
                        return box !== result.box;
                    }).forEach(function (box) {
                        Quagga.ImageDebug.drawPath(box, { color: "teal", lineWidth: 2 }, drawingCtx);
                    });
                }

                if (result.box) {
                    Quagga.ImageDebug.drawPath(result.box, { color: "#00F5FF", lineWidth: 2 }, drawingCtx);
                }

                if (result.codeResult && result.codeResult.code) {
                    Quagga.ImageDebug.drawPath(result.line, { color: 'rgb(0,255,0)', lineWidth: 3 }, drawingCtx);
                }
            }
        });
    </script>
</body>
</html>
