<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Entry App</title>
    <style>
         body { font-family: 'Roboto', sans-serif; margin: 10px; background-color: #f8f9fa; color: #343a40; }
        h1 { text-align: center; margin-bottom: 20px; color: #007bff; }
        .container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .left-pane { flex: 1; min-width: 300px; max-width: 550px; display: flex; flex-direction: column; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); background-color: #fff; }
       .list-box-container { border: 1px solid #ced4da; height: 200px; overflow-y: auto; margin-bottom: 10px; border-radius: 4px; }
        .list-box { list-style-type: none; padding: 0; margin: 0; }
        .list-box li { padding: 10px; cursor: pointer; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; border-bottom:1px solid #eee; border-radius: 4px; }
         .list-box li:hover { background-color: #e9ecef; }
        .list-box li span { display:inline-block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-right:1px solid #eee}
         .list-box li span:last-child{border:none;}
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; align-items:center; }
        .input-row label { width: 120px; text-align:right; color:#495057; font-size:0.9em; } /* Adjusted label size */
         .input-row input, .input-row select { flex: 1; min-width: 80px; padding:10px; border: 1px solid #ced4da; border-radius: 4px;} /* Adjusted padding */
         .input-row input[type="text"], .input-row input[type="number"], .input-row select {flex: 0.8;}
       .input-row input[type="text"].cost-input, .input-row input[type="number"].cost-input {flex: 0.4; min-width:50px}
         .uneditable-input-container {display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;}
        .uneditable-input { background-color: #f0f0f0; border: 1px solid #ced4da; padding: 10px; flex:1; min-width:100px; border-radius: 4px; }
        .uneditable-label { font-weight: bold; display: block; margin-bottom: 5px; color: #495057;}
        .right-pane { flex: 1; min-width: 300px; max-width: 800px; display: flex; flex-direction: column; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); background-color: #fff; }
       table { border-collapse: collapse; width: 100%; }
       table, th, td { border: 1px solid #ced4da; padding: 10px; text-align: left; white-space: nowrap; }
        th { background-color: #e9ecef; }
       input, button, select { margin-bottom: 10px; padding: 10px; border: 1px solid #ced4da; border-radius: 4px;}
       input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        button { cursor: pointer; background-color: #007bff; color: #fff; border: 1px solid #007bff; border-radius: 4px; transition: background-color 0.3s ease;}
         button:hover { background-color: #0056b3; border-color: #0056b3; }
        .homepage-buttons { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .homepage-buttons button { padding: 15px 20px; font-size:1.1em; }
         @media (max-width: 600px) {
            .container { flex-direction: column; align-items: center; }
            .left-pane, .right-pane { width: 95%; max-width: none; }
            .list-box li span {font-size:0.9em;}
           .uneditable-input, .uneditable-label {font-size:0.9em; }
            input, button, select {font-size:0.9em; padding:8px} /* Adjusted padding */
            table th, table td {padding:5px; font-size:0.8em;}
            .input-row {flex-direction:column; align-items:flex-start;}
            .input-row label { width: auto; text-align:left; margin-bottom: 3px;}
             .uneditable-input-container{flex-direction:column; }
        }
    </style>
</head>
<body>
    <h1>Data Entry</h1>
     <div id="homepage" class="homepage-buttons">
        <button onclick="showEditPricesForm()">تعديل أسعار</button>
        <button onclick="showAddItemForm()">إضافة صنف جديد</button>
    </div>

    <div id="editPricesForm" class="container" style="display: none;">
        <div class="left-pane">
           <button onclick="showHomepage()">الرئيسية</button>
            <input type="text" id="searchInput" placeholder="بحث..." />
             <div class="list-box-container">
                <ul id="itemList" class="list-box">
                     <li style="font-weight: bold; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;">
                       <span>الكود</span>
                        <span>كود PLU</span>
                        <span>الاسم</span>
                       <span>الحالة</span>
                   </li>
                </ul>
            </div>

            <div class="uneditable-input-container">
                 <div class="uneditable-input">
                     <span class="uneditable-label">الكود:</span>
                    <span id="codeDisplay"></span>
                </div>
               <div class="uneditable-input">
                   <span class="uneditable-label">كود PLU:</span>
                     <span id="pluCodeDisplay"></span>
                </div>
                <div class="uneditable-input">
                     <span class="uneditable-label">الحالة:</span>
                    <span id="statusDisplay"></span>
                </div>
            </div>
            <div class="uneditable-input" style="margin-bottom:10px"> <!-- Reduced margin -->
                 <span class="uneditable-label">الاسم:</span>
                   <span id="nameDisplay"></span>
            </div>

            <div class="input-row">
                 <label for="costInput">التكلفة:</label>
                <input type="number" id="costInput" class="cost-input" step="0.001" />
           </div>
           <div class="input-row">
                <label for="cairoMarginInput">نسبة القاهرة(%):</label>
                <input type="number" id="cairoMarginInput" class="cost-input" step="0.001" />
                <label for="coastMarginInput">نسبة الساحل(%):</label>
                <input type="number" id="coastMarginInput" class="cost-input" step="0.001" />
            </div>
            <div class="input-row">
                <label for="cairoCostInput">سعر القاهرة:</label>
                <input type="number" id="cairoCostInput" class="cost-input" readonly />
                <label for="sahelCostInput">سعر الساحل:</label>
                <input type="number" id="sahelCostInput" class="cost-input" readonly />
            </div>
           <div class="input-row">
               <label for="supplierInput">اسم المورد:</label>
                 <input type="text" id="supplierInput" />
             </div>
            <div class="input-row">
                 <label for="newStatusInput">الحالة الجديدة:</label>
                <select id="newStatusInput" style="flex:1">
                   <option value="" disabled selected>اختر حالة (اختياري)</option>
                     <option value="جاري">جاري</option>
                    <option value="موقوف">موقوف</option>
                 </select>
               <label for="expiryInput" style="margin-left: 10px;">صلاحية (يوم):</label>
                <input type="number" id="expiryInput" style="flex:1" />
            </div>

           <button id="addButton">حفظ</button>
        </div>

        <div class="right-pane">
            <button id="clearFieldsButton">مسح الحقول</button>
            <button id="extractButton">استخراج إلى Excel</button>
            <button id="saveImageButton">حفظ كصورة</button>
            <button id="clearTableButton">مسح الجدول</button>
             <table id="dataTable">
                <thead>
                    <tr>
                       <th>الكود</th>
                        <th>كود PLU</th>
                       <th>الاسم</th>
                       <th>الحالة الأصلية</th>
                        <th>التكلفة</th>
                       <th>القاهرة</th>
                        <th>الساحل</th>
                       <th>المورد</th>
                        <th>الحالة الجديدة</th>
                        <th>صلاحية</th>
                        <th>حذف</th>
                    </tr>
                </thead>
               <tbody id="dataTableBody"></tbody>
            </table>
        </div>
    </div>


    <div id="addItemForm" class="container" style="display: none;">
        <div class="left-pane">
             <button onclick="showHomepage()">الرئيسية</button>
             <h2>إضافة صنف جديد</h2>
           <div class="input-row">
                 <label for="newItemName">الاسم:</label>
                <input type="text" id="newItemName" />
            </div>
            <div class="input-row">
                <label for="newItemCost">سعر التكلفة:</label>
                 <input type="number" id="newItemCost" class="cost-input" step="0.001"/>
            </div>
            <div class="input-row">
                <label for="newItemCairoMargin">نسبة القاهرة(%):</label>
                <input type="number" id="newItemCairoMargin" class="cost-input" step="0.001"/>
                <label for="newItemCoastMargin">نسبة الساحل(%):</label>
                <input type="number" id="newItemCoastMargin" class="cost-input" step="0.001"/>
            </div>
             <div class="input-row">
                 <label for="newItemCairoCost">سعر القاهرة:</label>
                 <input type="number" id="newItemCairoCost" class="cost-input" readonly/>
            </div>
           <div class="input-row">
                <label for="newItemSahelCost">سعر الساحل:</label>
               <input type="number" id="newItemSahelCost" class="cost-input" readonly/>
            </div>

           <div class="input-row">
                <label for="newItemSupplier">اسم المورد:</label>
               <input type="text" id="newItemSupplier" />
           </div>
             <div class="input-row">
                <label for="newItemExpiry">صلاحية (يوم):</label>
                <input type="number" id="newItemExpiry"  />
           </div>

            <button id="addNewItemButton">حفظ</button>
        </div>

        <div class="right-pane">
           <button id="clearFieldsButtonNewItem">مسح الحقول</button>
            <button id="extractButtonNewItem">استخراج إلى Excel</button>
             <button id="saveImageButtonNewItem">حفظ كصورة</button>
           <button id="clearTableButtonNewItem">مسح الجدول</button>
            <table id="dataTableNewItem">
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>التكلفة</th>
                        <th>القاهرة</th>
                        <th>الساحل</th>
                         <th>المورد</th>
                       <th>صلاحية</th>
                        <th>حذف</th>
                    </tr>
                </thead>
                <tbody id="dataTableBodyNewItem"></tbody>
            </table>
        </div>
   </div>
     <script>
        const searchInput = document.getElementById('searchInput');
        const itemList = document.getElementById('itemList');
        const codeDisplay = document.getElementById('codeDisplay');
        const pluCodeDisplay = document.getElementById('pluCodeDisplay');
        const nameDisplay = document.getElementById('nameDisplay');
        const statusDisplay = document.getElementById('statusDisplay');

        // Edit Prices Form Inputs
        const costInput = document.getElementById('costInput');
        const cairoMarginInput = document.getElementById('cairoMarginInput');
        const coastMarginInput = document.getElementById('coastMarginInput');
        const cairoCostInput = document.getElementById('cairoCostInput'); // Readonly
        const sahelCostInput = document.getElementById('sahelCostInput'); // Readonly
        const supplierInput = document.getElementById('supplierInput');
        const newStatusInput = document.getElementById('newStatusInput');
        const expiryInput = document.getElementById('expiryInput');
        const addButton = document.getElementById('addButton');
        const dataTableBody = document.getElementById('dataTableBody');
        const clearFieldsButton = document.getElementById('clearFieldsButton');
        const extractButton = document.getElementById('extractButton');
        const saveImageButton = document.getElementById('saveImageButton');
        const dataTable = document.getElementById('dataTable');
        const clearTableButton = document.getElementById('clearTableButton');
        
        let database = [];
        let selectedItem = null;

        const editPricesForm = document.getElementById('editPricesForm');
        const addItemForm = document.getElementById('addItemForm');
        const homepage = document.getElementById('homepage');

        // Add New Item Form Inputs
        const newItemNameInput = document.getElementById('newItemName');
        const newItemCostInput = document.getElementById('newItemCost');
        const newItemCairoMarginInput = document.getElementById('newItemCairoMargin');
        const newItemCoastMarginInput = document.getElementById('newItemCoastMargin');
        const newItemCairoCostInput = document.getElementById('newItemCairoCost'); // Readonly
        const newItemSahelCostInput = document.getElementById('newItemSahelCost'); // Readonly
        const newItemSupplierInput = document.getElementById('newItemSupplier');
        const newItemExpiryInput = document.getElementById('newItemExpiry');
        const addNewItemButton = document.getElementById('addNewItemButton');
        const clearFieldsButtonNewItem = document.getElementById('clearFieldsButtonNewItem');
        const extractButtonNewItem = document.getElementById('extractButtonNewItem');
        const saveImageButtonNewItem = document.getElementById('saveImageButtonNewItem');
        const dataTableNewItem = document.getElementById('dataTableNewItem');
        const dataTableBodyNewItem = document.getElementById('dataTableBodyNewItem');
        const clearTableButtonNewItem = document.getElementById('clearTableButtonNewItem');

        const googleSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgnhSwtgtBcma96Oyg5-bWRhl_x3qu5N6DEucDQQO6MlsTsDgPteZ8qe87iK9D6w/pub?output=csv';

        async function fetchDataFromGoogleSheet() {
            console.log("Fetching data from Google Sheet...");
            try {
                const response = await fetch(googleSheetURL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                parseCSVData(csvText);
                updateList();
                console.log("Data fetched and parsed successfully.");
            } catch (error) {
                console.error("Could not fetch or parse data from Google Sheet:", error);
                alert("حدث خطأ أثناء تحميل البيانات من جدول جوجل. يرجى المحاولة مرة أخرى لاحقًا أو التأكد من الرابط.");
                itemList.innerHTML = '<li>فشل تحميل البيانات.</li>';
            }
        }

        function parseCSVData(csvText) {
            const rows = csvText.trim().split('\n');
            if (rows.length < 2) {
                console.warn("CSV data is empty or only has headers.");
                database = [];
                return;
            }

            const rawHeaders = rows[0].split(',');
            const headers = rawHeaders.map(header => header.trim().toLowerCase()); // Normalize headers

            const codeIndex = headers.indexOf('code');
            const barcodeIndex = headers.indexOf('barcode');
            const pluIndex = headers.indexOf('plu');
            const nameIndex = headers.indexOf('name');
            const statusIndex = headers.indexOf('status');
            const cairoMarginIndex = headers.indexOf('cairo margin');
            const coastMarginIndex = headers.indexOf('coast margin');

            if ([codeIndex, barcodeIndex, pluIndex, nameIndex, statusIndex, cairoMarginIndex, coastMarginIndex].some(index => index === -1)) {
                console.error("One or more required columns (code, barcode, plu, name, status, cairo margin, coast margin) not found in CSV headers. Found:", rawHeaders.join(', '));
                alert("أعمدة البيانات المطلوبة غير موجودة في الملف. تأكد من أن الملف يحتوي على الأعمدة الصحيحة بالترتيب المتوقع.");
                database = [];
                return;
            }

            database = rows.slice(1)
                .map(row => {
                    const values = row.split(',');
                    const cairoMargin = parseFloat(values[cairoMarginIndex]?.trim());
                    const coastMargin = parseFloat(values[coastMarginIndex]?.trim());
                    return {
                        code: values[codeIndex]?.trim() || '',
                        barcode: values[barcodeIndex]?.trim() || '',
                        pluCode: values[pluIndex]?.trim() || '', // Using 'plu' for pluCode display
                        name: values[nameIndex]?.trim() || '',
                        status: values[statusIndex]?.trim() || '',
                        cairoMargin: !isNaN(cairoMargin) ? cairoMargin : 0,
                        coastMargin: !isNaN(coastMargin) ? coastMargin : 0
                    };
                })
                .filter(item => item.code || item.pluCode || item.name);
        }

        function formatToThreeDecimals(numStr) {
            const num = parseFloat(numStr);
            if (isNaN(num)) return "0.000";
            return num.toFixed(3);
        }

        function updateCalculatedPrices() {
            const cost = parseFloat(costInput.value);
            const cairoMargin = parseFloat(cairoMarginInput.value);
            const coastMargin = parseFloat(coastMarginInput.value);

            let cairoPrice = 0;
            let sahelPrice = 0;

            if (!isNaN(cost) && cost > 0) {
                if (!isNaN(cairoMargin) && cairoMargin >= 0 && cairoMargin < 100) {
                    cairoPrice = cost / (1 - (cairoMargin / 100));
                }
                if (!isNaN(coastMargin) && coastMargin >= 0 && coastMargin < 100) {
                    sahelPrice = cost / (1 - (coastMargin / 100));
                }
            }
            cairoCostInput.value = cairoPrice.toFixed(3);
            sahelCostInput.value = sahelPrice.toFixed(3);
        }

        function updateCalculatedNewItemPrices() {
            const cost = parseFloat(newItemCostInput.value);
            const cairoMargin = parseFloat(newItemCairoMarginInput.value);
            const coastMargin = parseFloat(newItemCoastMarginInput.value);

            let cairoPrice = 0;
            let sahelPrice = 0;

            if (!isNaN(cost) && cost > 0) {
                if (!isNaN(cairoMargin) && cairoMargin >= 0 && cairoMargin < 100) {
                    cairoPrice = cost / (1 - (cairoMargin / 100));
                }
                if (!isNaN(coastMargin) && coastMargin >= 0 && coastMargin < 100) {
                    sahelPrice = cost / (1 - (coastMargin / 100));
                }
            }
            newItemCairoCostInput.value = cairoPrice.toFixed(3);
            newItemSahelCostInput.value = sahelPrice.toFixed(3);
        }


        // Event Listeners for Edit Prices Form
        costInput.addEventListener('input', updateCalculatedPrices);
        cairoMarginInput.addEventListener('input', updateCalculatedPrices);
        coastMarginInput.addEventListener('input', updateCalculatedPrices);
        searchInput.addEventListener('input', filterList);
        addButton.addEventListener('click', addItemToTable);
        clearFieldsButton.addEventListener('click', clearAll);
        extractButton.addEventListener('click', extractToExcel);
        saveImageButton.addEventListener('click', saveTableAsImage);
        clearTableButton.addEventListener('click', clearTable);

        // Event Listeners for Add New Item Form
        newItemCostInput.addEventListener('input', updateCalculatedNewItemPrices);
        newItemCairoMarginInput.addEventListener('input', updateCalculatedNewItemPrices);
        newItemCoastMarginInput.addEventListener('input', updateCalculatedNewItemPrices);
        addNewItemButton.addEventListener('click', addNewItemToTable);
        clearFieldsButtonNewItem.addEventListener('click', clearInputsNewItemAndCalculated);
        extractButtonNewItem.addEventListener('click', extractToExcelNewItem);
        saveImageButtonNewItem.addEventListener('click', saveTableAsImageNewItem);
        clearTableButtonNewItem.addEventListener('click', clearTableNewItem);


        function showHomepage(){
            editPricesForm.style.display = 'none';
            addItemForm.style.display = 'none';
            homepage.style.display = 'flex';
            clearInputsNewItemAndCalculated();
            clearInputsAndCalculated();
       }

       function showEditPricesForm(){
           editPricesForm.style.display = 'flex';
           addItemForm.style.display = 'none';
            homepage.style.display = 'none';
             clearInputsNewItemAndCalculated();
        }

        function showAddItemForm(){
            addItemForm.style.display = 'flex';
             editPricesForm.style.display = 'none';
            homepage.style.display = 'none';
           clearInputsAndCalculated();
        }

        function updateList() {
             itemList.innerHTML = `
                <li style="font-weight: bold; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;">
                    <span>الكود</span>
                    <span>كود PLU</span>
                    <span>الاسم</span>
                     <span>الحالة</span>
                </li>
            `;
            if (!database || database.length === 0) {
                 itemList.innerHTML += '<li>لا توجد بيانات لعرضها.</li>';
                 return;
            }
            database.forEach(item => {
                 const listItem = document.createElement('li');
                listItem.innerHTML = `
                     <span title="${item.code}">${item.code || 'N/A'}</span>
                    <span title="${item.pluCode}">${item.pluCode || 'N/A'}</span>
                    <span title="${item.name}">${item.name || 'N/A'}</span>
                    <span title="${item.status}">${item.status || 'N/A'}</span>
               `;
                listItem.addEventListener('click', function() {
                    selectedItem = item;
                    codeDisplay.textContent = item.code || '';
                    pluCodeDisplay.textContent = item.pluCode || ''; // This is item.plu from CSV
                    nameDisplay.textContent = item.name || '';
                    statusDisplay.textContent = item.status || '';
                    
                    costInput.value = ''; // Clear previous cost
                    cairoMarginInput.value = item.cairoMargin !== undefined ? item.cairoMargin.toFixed(3) : '0.000';
                    coastMarginInput.value = item.coastMargin !== undefined ? item.coastMargin.toFixed(3) : '0.000';
                    updateCalculatedPrices(); // Update calculated fields based on new margins (cost is 0 for now)
                });
                itemList.appendChild(listItem);
            });
        }

       function filterList() {
            const searchTerm = searchInput.value.toLowerCase();
            itemList.innerHTML = `
                 <li style="font-weight: bold; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;">
                     <span>الكود</span>
                     <span>كود PLU</span>
                    <span>الاسم</span>
                    <span>الحالة</span>
                </li>
            `;
            if (!database || database.length === 0) {
                 itemList.innerHTML += '<li>لا توجد بيانات للبحث فيها.</li>';
                 return;
            }
           const filteredList = database.filter(item => {
                 return Object.values(item).some(value =>
                    String(value).toLowerCase().includes(searchTerm)
                );
            });
            if (filteredList.length === 0) {
                itemList.innerHTML += '<li>لا توجد نتائج مطابقة للبحث.</li>';
            } else {
                filteredList.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                       <span title="${item.code}">${item.code || 'N/A'}</span>
                        <span title="${item.pluCode}">${item.pluCode || 'N/A'}</span>
                       <span title="${item.name}">${item.name || 'N/A'}</span>
                        <span title="${item.status}">${item.status || 'N/A'}</span>
                    `;
                    listItem.addEventListener('click', function() {
                        selectedItem = item;
                        codeDisplay.textContent = item.code || '';
                        pluCodeDisplay.textContent = item.pluCode || '';
                        nameDisplay.textContent = item.name || '';
                        statusDisplay.textContent = item.status || '';

                        costInput.value = ''; // Clear previous cost
                        cairoMarginInput.value = item.cairoMargin !== undefined ? item.cairoMargin.toFixed(3) : '0.000';
                        coastMarginInput.value = item.coastMargin !== undefined ? item.coastMargin.toFixed(3) : '0.000';
                        updateCalculatedPrices();
                    });
                   itemList.appendChild(listItem);
                });
            }
        }

        function addItemToTable() {
            if (!selectedItem) {
                 alert('الرجاء اختيار صنف من القائمة.');
                return;
            }
            const costVal = parseFloat(costInput.value);
            if (isNaN(costVal) || costVal <= 0) {
                alert('الرجاء إدخال تكلفة صحيحة وأكبر من الصفر.');
                return;
            }

            const supplier = supplierInput.value;
            const newStatus = newStatusInput.value;
            const expiry = expiryInput.value;

             if(expiry && (isNaN(expiry) || expiry < 0)){
                alert("الرجاء إدخال عدد أيام صلاحية صحيح.");
                 return;
             }

             const newRow = dataTableBody.insertRow();
            newRow.insertCell().textContent = selectedItem.code || 'N/A';
            newRow.insertCell().textContent = selectedItem.pluCode || 'N/A';
            newRow.insertCell().textContent = selectedItem.name || 'N/A';
            newRow.insertCell().textContent = selectedItem.status || 'N/A'; 
            newRow.insertCell().textContent = formatToThreeDecimals(costInput.value);
            newRow.insertCell().textContent = formatToThreeDecimals(cairoCostInput.value); // Already calculated
            newRow.insertCell().textContent = formatToThreeDecimals(sahelCostInput.value); // Already calculated
            newRow.insertCell().textContent = supplier;
            newRow.insertCell().textContent = newStatus || (selectedItem.status || 'N/A'); 
            newRow.insertCell().textContent = expiry || '';
            const deleteButton = document.createElement('button');
             deleteButton.textContent = 'حذف';
            deleteButton.addEventListener('click', function() {
                 dataTableBody.deleteRow(newRow.rowIndex - 1);
            });
            newRow.insertCell().appendChild(deleteButton);
            selectedItem = null;
            clearInputsAndCalculated();
       }

        function clearInputsAndCalculated() {
           codeDisplay.textContent = '';
            pluCodeDisplay.textContent = '';
            nameDisplay.textContent = '';
            statusDisplay.textContent = '';
            costInput.value = '';
            cairoMarginInput.value = '';
            coastMarginInput.value = '';
            // cairoCostInput.value = '0.000'; // Will be cleared by updateCalculatedPrices
            // sahelCostInput.value = '0.000'; // Will be cleared by updateCalculatedPrices
            supplierInput.value = '';
            newStatusInput.value = '';
            expiryInput.value = '';
            selectedItem = null;
            updateCalculatedPrices(); // This will set calculated fields to 0.000 if cost/margins are empty
       }

        function clearAll() { 
            clearInputsAndCalculated();
        }

        function extractToExcel() {
            const headers = ['الكود', 'كود PLU', 'الاسم', 'الحالة الأصلية', 'التكلفة', 'القاهرة', 'الساحل', 'المورد', 'الحالة الجديدة', 'صلاحية'];
            const data = [];
             const rows = dataTableBody.querySelectorAll('tr');
           rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                const rowData = cells.slice(0, -1).map(cell => cell.textContent);
                 data.push(rowData);
           });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
             XLSX.writeFile(wb, 'table_data.xlsx'); 
        }

         function saveTableAsImage() {
            html2canvas(dataTable, {scale: 3}).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
               const downloadLink = document.createElement('a');
                downloadLink.href = imgData;
                downloadLink.download = 'table_data.jpg';
                 document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            }).catch(err => {
                console.error("Error generating image: ", err);
                alert("خطأ في إنشاء الصورة. تحقق من وحدة التحكم لمزيد من التفاصيل.");
            });
        }

        function addNewItemToTable() {
           const name = newItemNameInput.value;
           const costVal = parseFloat(newItemCostInput.value);

            if (!name) {
                alert("الرجاء إدخال اسم الصنف.");
                return;
            }
            if (isNaN(costVal) || costVal <= 0) {
                alert('الرجاء إدخال تكلفة صحيحة وأكبر من الصفر.');
                return;
            }

           const supplier = newItemSupplierInput.value;
           const expiry = newItemExpiryInput.value;
            if(expiry && (isNaN(expiry) || expiry < 0)){
                 alert("الرجاء إدخال عدد أيام صلاحية صحيح.");
                 return;
             }

           const newRow = dataTableBodyNewItem.insertRow();
           newRow.insertCell().textContent = name;
            newRow.insertCell().textContent = formatToThreeDecimals(newItemCostInput.value);
            newRow.insertCell().textContent = formatToThreeDecimals(newItemCairoCostInput.value); // Already calculated
            newRow.insertCell().textContent = formatToThreeDecimals(newItemSahelCostInput.value); // Already calculated
            newRow.insertCell().textContent = supplier;
            newRow.insertCell().textContent = expiry || '';
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'حذف';
            deleteButton.addEventListener('click', function() {
                dataTableBodyNewItem.deleteRow(newRow.rowIndex - 1);
           });
            newRow.insertCell().appendChild(deleteButton);
            clearInputsNewItemAndCalculated();
        }

        function clearInputsNewItemAndCalculated() {
            newItemNameInput.value = '';
            newItemCostInput.value = '';
            newItemCairoMarginInput.value = '';
            newItemCoastMarginInput.value = '';
            // newItemCairoCostInput.value = '0.000'; // Will be cleared by updateCalculatedNewItemPrices
            // newItemSahelCostInput.value = '0.000'; // Will be cleared by updateCalculatedNewItemPrices
            newItemSupplierInput.value = '';
            newItemExpiryInput.value = '';
            updateCalculatedNewItemPrices(); // This will set calculated fields to 0.000
        }

        function extractToExcelNewItem() {
             const headers = ['الاسم', 'التكلفة', 'القاهرة', 'الساحل', 'المورد', 'صلاحية'];
             const data = [];
            const rows = dataTableBodyNewItem.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                const rowData = cells.slice(0, -1).map(cell => cell.textContent);
                data.push(rowData);
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            XLSX.utils.book_append_sheet(wb, ws, 'Data New Items');
             XLSX.writeFile(wb, 'table_data_new_item.xlsx');
        }

         function saveTableAsImageNewItem() {
             html2canvas(dataTableNewItem, {scale: 3}).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
               const downloadLink = document.createElement('a');
                 downloadLink.href = imgData;
                downloadLink.download = 'table_data_new_item.jpg';
                 document.body.appendChild(downloadLink);
                 downloadLink.click();
                document.body.removeChild(downloadLink);
            }).catch(err => {
                console.error("Error generating image for new items: ", err);
                alert("خطأ في إنشاء الصورة للأصناف الجديدة. تحقق من وحدة التحكم لمزيد من التفاصيل.");
            });
        }

       function clearTable() {
           dataTableBody.innerHTML = '';
        }
       function clearTableNewItem() {
          dataTableBodyNewItem.innerHTML = '';
       }

       fetchDataFromGoogleSheet();

    </script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
