<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Entry App</title>
    <style>
         body { font-family: 'Roboto', sans-serif; margin: 10px; background-color: #f8f9fa; color: #343a40; }
        h1 { text-align: center; margin-bottom: 20px; color: #007bff; }
        .container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .left-pane { flex: 1; min-width: 300px; max-width: 550px; display: flex; flex-direction: column; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); background-color: #fff; }
       .list-box-container { border: 1px solid #ced4da; height: 200px; overflow-y: auto; margin-bottom: 10px; border-radius: 4px; }
        .list-box { list-style-type: none; padding: 0; margin: 0; }
        .list-box li { padding: 10px; cursor: pointer; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; border-bottom:1px solid #eee; border-radius: 4px; }
         .list-box li:hover { background-color: #e9ecef; }
        .list-box li span { display:inline-block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-right:1px solid #eee}
         .list-box li span:last-child{border:none;}
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; align-items:center; }
        .input-row label { width: 120px; text-align:right; color:#495057; }
         .input-row input, .input-row select { flex: 1; min-width: 80px; padding:12px; border: 1px solid #ced4da; border-radius: 4px;}
         .input-row input[type="text"], .input-row input[type="number"], .input-row select {flex: 0.8;}
       .input-row input[type="text"].cost-input, .input-row input[type="number"].cost-input {flex: 0.4; min-width:50px}
         .uneditable-input-container {display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap;}
        .uneditable-input { background-color: #f0f0f0; border: 1px solid #ced4da; padding: 10px; flex:1; min-width:100px; border-radius: 4px; }
        .uneditable-label { font-weight: bold; display: block; margin-bottom: 5px; color: #495057;}
        .right-pane { flex: 1; min-width: 300px; max-width: 800px; display: flex; flex-direction: column; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); background-color: #fff; }
       table { border-collapse: collapse; width: 100%; }
       table, th, td { border: 1px solid #ced4da; padding: 10px; text-align: left; white-space: nowrap; }
        th { background-color: #e9ecef; }
       input, button, select { margin-bottom: 10px; padding: 10px; border: 1px solid #ced4da; border-radius: 4px;}
        button { cursor: pointer; background-color: #007bff; color: #fff; border: 1px solid #007bff; border-radius: 4px; transition: background-color 0.3s ease;}
         button:hover { background-color: #0056b3; border-color: #0056b3; }
        .homepage-buttons { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .homepage-buttons button { padding: 15px 20px; font-size:1.1em; }
         @media (max-width: 600px) {
            .container { flex-direction: column; align-items: center; }
            .left-pane, .right-pane { width: 95%; max-width: none; }
            .list-box li span {font-size:0.9em;}
           .uneditable-input, .uneditable-label {font-size:0.9em; }
            input, button, select {font-size:0.9em; padding:5px}
            table th, table td {padding:5px; font-size:0.8em;}
            .input-row {flex-direction:column; align-items:flex-start;}
            .input-row label { width: auto; text-align:left; }
             .uneditable-input-container{flex-direction:column; }
        }
    </style>
</head>
<body>
    <h1>Data Entry</h1>
     <div id="homepage" class="homepage-buttons">
        <button onclick="showEditPricesForm()">تعديل أسعار</button>
        <button onclick="showAddItemForm()">إضافة صنف جديد</button>
    </div>

    <div id="editPricesForm" class="container" style="display: none;">
        <div class="left-pane">
           <button onclick="showHomepage()">الرئيسية</button>
           <!-- File input removed -->
            <input type="text" id="searchInput" placeholder="بحث..." />
             <div class="list-box-container">
                <ul id="itemList" class="list-box">
                     <li style="font-weight: bold; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;">
                       <span>الكود</span>
                        <span>كود PLU (الباركود)</span>
                        <span>الاسم</span>
                       <span>الحالة</span>
                   </li>
                   <!-- Items will be populated by JavaScript -->
                </ul>
            </div>

            <div class="uneditable-input-container">
                 <div class="uneditable-input">
                     <span class="uneditable-label">الكود:</span>
                    <span id="codeDisplay"></span>
                </div>
               <div class="uneditable-input">
                   <span class="uneditable-label">كود PLU (الباركود):</span>
                     <span id="pluCodeDisplay"></span>
                </div>
                <div class="uneditable-input">
                     <span class="uneditable-label">الحالة:</span>
                    <span id="statusDisplay"></span>
                </div>
            </div>
            <div class="uneditable-input" style="margin-bottom:20px">
                 <span class="uneditable-label">الاسم:</span>
                   <span id="nameDisplay"></span>
            </div>

            <div class="input-row">
                 <label for="costInput">التكلفة:</label>
                <input type="number" id="costInput" maxlength="5" class="cost-input" />
                <label for="percentageInput">نسبة مئوية(%):</label>
                 <input type="number" id="percentageInput" style="flex:0.5"  />
           </div>
            <div class="input-row">
                <label for="cairoCostInput">القاهرة:</label>
                <input type="number" id="cairoCostInput" maxlength="5"  class="cost-input"/>
                <label for="sahelCostInput">الساحل:</label>
                <input type="number" id="sahelCostInput" maxlength="5" class="cost-input" />
            </div>
           <div class="input-row">
               <label for="supplierInput">اسم المورد:</label>
                 <input type="text" id="supplierInput" />
             </div>
            <div class="input-row">
                 <label for="newStatusInput">الحالة:</label>
                <select id="newStatusInput" style="flex:1">
                   <option value="" disabled selected>اختر حالة (اختياري)</option>
                     <option value="جاري">جاري</option>
                     <option value="Active">Active</option> <!-- Added from potential CSV values -->
                     <option value="موقوف">موقوف</option>
                     <option value="Inactive">Inactive</option> <!-- Added from potential CSV values -->
                 </select>
               <label for="expiryInput" style="margin-left: 10px;">صلاحية:</label>
                <input type="number" id="expiryInput" style="flex:1" />
            </div>

           <button id="addButton">حفظ</button>
        </div>

        <div class="right-pane">
            <button id="clearFieldsButton">مسح الحقول</button>
            <button id="extractButton">استخراج إلى Excel</button>
            <button id="saveImageButton">حفظ كصورة</button>
            <button id="clearTableButton">مسح الجدول</button>
             <table id="dataTable">
                <thead>
                    <tr>
                       <th>الكود</th>
                        <th>كود PLU (الباركود)</th>
                       <th>الاسم</th>
                       <th>الحالة الأصلية</th>
                        <th>التكلفة</th>
                       <th>القاهرة</th>
                        <th>الساحل</th>
                       <th>المورد</th>
                        <th>الحالة الجديدة</th>
                        <th>صلاحية</th>
                        <th>حذف</th>
                    </tr>
                </thead>
               <tbody id="dataTableBody"></tbody>
            </table>
        </div>
    </div>


    <div id="addItemForm" class="container" style="display: none;">
        <div class="left-pane">
             <button onclick="showHomepage()">الرئيسية</button>
             <h2>إضافة صنف جديد</h2>
           <div class="input-row">
                 <label for="newItemName">الاسم:</label>
                <input type="text" id="newItemName" />
            </div>
            <div class="input-row">
                <label for="newItemCost">سعر التكلفة:</label>
                 <input type="number" id="newItemCost" maxlength="5" class="cost-input"/>
                  <label for="percentageInputNewItem">نسبة مئوية(%):</label>
                   <input type="number" id="percentageInputNewItem" style="flex:0.5"  />

            </div>
             <div class="input-row">
                 <label for="newItemCairoCost">القاهرة:</label>
                 <input type="number" id="newItemCairoCost" maxlength="5" class="cost-input"/>
            </div>
           <div class="input-row">
                <label for="newItemSahelCost">الساحل:</label>
               <input type="number" id="newItemSahelCost" maxlength="5" class="cost-input"/>
            </div>

           <div class="input-row">
                <label for="newItemSupplier">اسم المورد:</label>
               <input type="text" id="newItemSupplier" />
           </div>
             <div class="input-row">
                <label for="newItemExpiry">صلاحية:</label>
                <input type="number" id="newItemExpiry"  />
           </div>

            <button id="addNewItemButton">حفظ</button>
        </div>

        <div class="right-pane">
           <button id="clearFieldsButtonNewItem">مسح الحقول</button>
            <button id="extractButtonNewItem">استخراج إلى Excel</button>
             <button id="saveImageButtonNewItem">حفظ كصورة</button>
           <button id="clearTableButtonNewItem">مسح الجدول</button>
            <table id="dataTableNewItem">
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>التكلفة</th>
                        <th>القاهرة</th>
                        <th>الساحل</th>
                         <th>المورد</th>
                       <th>صلاحية</th>
                        <th>حذف</th>
                    </tr>
                </thead>
                <tbody id="dataTableBodyNewItem"></tbody>
            </table>
        </div>
   </div>
     <script>
        // const fileInput = document.getElementById('fileInput'); // Removed
         const searchInput = document.getElementById('searchInput');
        const itemList = document.getElementById('itemList');
        const codeDisplay = document.getElementById('codeDisplay');
       const pluCodeDisplay = document.getElementById('pluCodeDisplay');
        const nameDisplay = document.getElementById('nameDisplay');
        const statusDisplay = document.getElementById('statusDisplay');
         const costInput = document.getElementById('costInput');
       const cairoCostInput = document.getElementById('cairoCostInput');
        const sahelCostInput = document.getElementById('sahelCostInput');
        const supplierInput = document.getElementById('supplierInput');
         const newStatusInput = document.getElementById('newStatusInput');
       const expiryInput = document.getElementById('expiryInput');
         const addButton = document.getElementById('addButton');
        const dataTableBody = document.getElementById('dataTableBody');
        const clearFieldsButton = document.getElementById('clearFieldsButton');
         const extractButton = document.getElementById('extractButton');
        const saveImageButton = document.getElementById('saveImageButton');
        const dataTable = document.getElementById('dataTable');
        
        // Initialize database as an empty array; it will be populated from Google Sheets
        let database = [];
        let selectedItem = null;

        const editPricesForm = document.getElementById('editPricesForm');
         const addItemForm = document.getElementById('addItemForm');
       const homepage = document.getElementById('homepage');

        const newItemNameInput = document.getElementById('newItemName');
        const newItemCostInput = document.getElementById('newItemCost');
       const newItemCairoCostInput = document.getElementById('newItemCairoCost');
        const newItemSahelCostInput = document.getElementById('newItemSahelCost');
         const newItemSupplierInput = document.getElementById('newItemSupplier');
       const newItemExpiryInput = document.getElementById('newItemExpiry');
         const addNewItemButton = document.getElementById('addNewItemButton');

        const clearFieldsButtonNewItem = document.getElementById('clearFieldsButtonNewItem');
        const extractButtonNewItem = document.getElementById('extractButtonNewItem');
        const saveImageButtonNewItem = document.getElementById('saveImageButtonNewItem');
        const dataTableNewItem = document.getElementById('dataTableNewItem');
       const dataTableBodyNewItem = document.getElementById('dataTableBodyNewItem');
        const clearTableButton = document.getElementById('clearTableButton');
         const clearTableButtonNewItem = document.getElementById('clearTableButtonNewItem');
        const percentageInput = document.getElementById('percentageInput');
        const percentageInputNewItem = document.getElementById('percentageInputNewItem');

        // Fetch data from Google Sheet when the script loads
        const googleSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgnhSwtgtBcma96Oyg5-bWRhl_x3qu5N6DEucDQQO6MlsTsDgPteZ8qe87iK9D6w/pub?output=csv';

        async function fetchDataFromGoogleSheet() {
            console.log("Fetching data from Google Sheet...");
            try {
                const response = await fetch(googleSheetURL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                parseCSVData(csvText);
                updateList(); // Populate the list once data is parsed
                console.log("Data fetched and parsed successfully.");
            } catch (error) {
                console.error("Could not fetch or parse data from Google Sheet:", error);
                alert("حدث خطأ أثناء تحميل البيانات من جدول جوجل. يرجى المحاولة مرة أخرى لاحقًا أو التأكد من الرابط.");
                // Optionally, display a message to the user in the UI
                itemList.innerHTML = '<li>فشل تحميل البيانات.</li>';
            }
        }

        function parseCSVData(csvText) {
            const rows = csvText.trim().split('\n');
            if (rows.length < 2) { // Check if there's at least one header and one data row
                console.warn("CSV data is empty or only has headers.");
                database = [];
                return;
            }

            const headers = rows[0].split(',').map(header => header.trim());
            // Find column indices - case insensitive and trim whitespace
            const codeIndex = headers.findIndex(h => h.toLowerCase() === 'code');
            const barcodeIndex = headers.findIndex(h => h.toLowerCase() === 'barcode');
            const nameIndex = headers.findIndex(h => h.toLowerCase() === 'describtion arabic'); // Corrected spelling
            const statusIndex = headers.findIndex(h => h.toLowerCase() === 'status');

            if (codeIndex === -1 || barcodeIndex === -1 || nameIndex === -1 || statusIndex === -1) {
                console.error("Required columns (CODE, BARCODE, DESCRIBTION ARABIC, STATUS) not found in CSV headers:", headers);
                alert("أعمدة البيانات المطلوبة غير موجودة في الملف. تأكد من أن الملف يحتوي على الأعمدة: CODE, BARCODE, DESCRIBTION ARABIC, STATUS");
                database = [];
                return;
            }

            database = rows.slice(1) // Skip header row
                .map(row => {
                    const values = row.split(',');
                    // Handle cases where a row might not have enough columns by providing defaults or empty strings
                    return {
                        code: values[codeIndex] ? values[codeIndex].trim() : '',
                        pluCode: values[barcodeIndex] ? values[barcodeIndex].trim() : '', // BARCODE maps to pluCode
                        name: values[nameIndex] ? values[nameIndex].trim() : '',
                        status: values[statusIndex] ? values[statusIndex].trim() : ''
                    };
                })
                .filter(item => item.code || item.pluCode || item.name); // Filter out completely empty rows if any
        }


       // fileInput.addEventListener('change', handleFileUpload); // Removed
        searchInput.addEventListener('input', filterList);
        addButton.addEventListener('click', addItemToTable);
         clearFieldsButton.addEventListener('click', clearAll);
         extractButton.addEventListener('click', extractToExcel);
       saveImageButton.addEventListener('click', saveTableAsImage);

       addNewItemButton.addEventListener('click', addNewItemToTable);
        clearFieldsButtonNewItem.addEventListener('click', clearInputsNewItem);
        extractButtonNewItem.addEventListener('click', extractToExcelNewItem);
       saveImageButtonNewItem.addEventListener('click', saveTableAsImageNewItem);
       clearTableButton.addEventListener('click', clearTable);
        clearTableButtonNewItem.addEventListener('click', clearTableNewItem);


        function showHomepage(){
            editPricesForm.style.display = 'none';
           addItemForm.style.display = 'none';
           homepage.style.display = 'flex';
             clearInputsNewItem();
           clearInputs();
       }

       function showEditPricesForm(){
           editPricesForm.style.display = 'flex';
           addItemForm.style.display = 'none';
            homepage.style.display = 'none';
             clearInputsNewItem();
        }

        function showAddItemForm(){
            addItemForm.style.display = 'flex';
             editPricesForm.style.display = 'none';
            homepage.style.display = 'none';
           clearInputs();
        }

        // handleFileUpload function removed

        function updateList() {
             itemList.innerHTML = `
                <li style="font-weight: bold; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;">
                    <span>الكود</span>
                    <span>كود PLU (الباركود)</span>
                    <span>الاسم</span>
                     <span>الحالة</span>
                </li>
            `;
            if (!database || database.length === 0) {
                 itemList.innerHTML += '<li>لا توجد بيانات لعرضها.</li>';
                 return;
            }
            database.forEach(item => {
                 const listItem = document.createElement('li');
                listItem.innerHTML = `
                     <span title="${item.code}">${item.code || 'N/A'}</span>
                    <span title="${item.pluCode}">${item.pluCode || 'N/A'}</span>
                    <span title="${item.name}">${item.name || 'N/A'}</span>
                    <span title="${item.status}">${item.status || 'N/A'}</span>
               `;
                listItem.addEventListener('click', function() {
                    selectedItem = item;
                     codeDisplay.textContent = item.code || '';
                    pluCodeDisplay.textContent = item.pluCode || '';
                    nameDisplay.textContent = item.name || '';
                     statusDisplay.textContent = item.status || '';
                });
                itemList.appendChild(listItem);
            });
        }

       function filterList() {
            const searchTerm = searchInput.value.toLowerCase();
            itemList.innerHTML = `
                 <li style="font-weight: bold; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;">
                     <span>الكود</span>
                     <span>كود PLU (الباركود)</span>
                    <span>الاسم</span>
                    <span>الحالة</span>
                </li>
            `;
            if (!database || database.length === 0) {
                 itemList.innerHTML += '<li>لا توجد بيانات للبحث فيها.</li>';
                 return;
            }
           const filteredList = database.filter(item => {
                 return Object.values(item).some(value =>
                    String(value).toLowerCase().includes(searchTerm)
                );
            });
            if (filteredList.length === 0) {
                itemList.innerHTML += '<li>لا توجد نتائج مطابقة للبحث.</li>';
            } else {
                filteredList.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                       <span title="${item.code}">${item.code || 'N/A'}</span>
                        <span title="${item.pluCode}">${item.pluCode || 'N/A'}</span>
                       <span title="${item.name}">${item.name || 'N/A'}</span>
                        <span title="${item.status}">${item.status || 'N/A'}</span>
                    `;
                    listItem.addEventListener('click', function() {
                        selectedItem = item;
                        codeDisplay.textContent = item.code || '';
                         pluCodeDisplay.textContent = item.pluCode || '';
                        nameDisplay.textContent = item.name || '';
                        statusDisplay.textContent = item.status || '';
                    });
                   itemList.appendChild(listItem);
                });
            }
        }

        function addItemToTable() {
            if (!selectedItem) {
                 alert('الرجاء اختيار صنف من القائمة.');
                return;
            }
            const cost = costInput.value;
            const cairoCost = cairoCostInput.value;
             const sahelCost = sahelCostInput.value;
             const supplier = supplierInput.value;
            const newStatus = newStatusInput.value; // This is the *new* status from the dropdown
            const expiry = expiryInput.value;
             const percentage = percentageInput.value;

             if(expiry && (isNaN(expiry) || expiry < 0)){ // also check for negative expiry
                alert("الرجاء إدخال عدد أيام صلاحية صحيح.");
                 return;
             }
             let calculatedCairoCost = cairoCost;
            let calculatedSahelCost = sahelCost;

            if (cost && percentage) { // Calculate only if both cost and percentage are provided
                const costValue = parseFloat(cost);
                const percentageValue = parseFloat(percentage) / 100;
                 if(!isNaN(costValue) && !isNaN(percentageValue) && percentageValue < 1 && percentageValue >= 0) { // Ensure percentage is valid
                    calculatedCairoCost = (costValue / (1 - percentageValue)).toFixed(2);
                    calculatedSahelCost = (costValue / (1 - percentageValue)).toFixed(2);
                 } else if (percentageValue >= 1 || percentageValue < 0) {
                    alert("النسبة المئوية يجب أن تكون بين 0 و 99.");
                    // Don't proceed if percentage is invalid, or clear percentage input
                 }
            } else if (cost && !percentage) { // If only cost is given, use manual cairo/sahel if provided
                calculatedCairoCost = cairoCost || '0'; // Default to 0 if not provided
                calculatedSahelCost = sahelCost || '0';
            } else if (!cost && percentage) {
                 alert("الرجاء إدخال التكلفة أولاً لتطبيق النسبة المئوية.");
                 return;
            }


             const newRow = dataTableBody.insertRow();
            newRow.insertCell().textContent = selectedItem.code || 'N/A';
            newRow.insertCell().textContent = selectedItem.pluCode || 'N/A';
            newRow.insertCell().textContent = selectedItem.name || 'N/A';
             newRow.insertCell().textContent = selectedItem.status || 'N/A'; // Original status
             newRow.insertCell().textContent = cost || '0';
            newRow.insertCell().textContent = calculatedCairoCost || '0';
             newRow.insertCell().textContent = calculatedSahelCost || '0';
           newRow.insertCell().textContent = supplier;
            newRow.insertCell().textContent = newStatus || (selectedItem.status || 'N/A'); // New status, or original if not changed
            newRow.insertCell().textContent = expiry;
            const deleteButton = document.createElement('button');
             deleteButton.textContent = 'حذف';
            deleteButton.addEventListener('click', function() {
                 dataTableBody.deleteRow(newRow.rowIndex - 1);
            });
            newRow.insertCell().appendChild(deleteButton);
           selectedItem = null; // Deselect item
            clearInputs();
       }

        function clearInputs() {
           codeDisplay.textContent = '';
            pluCodeDisplay.textContent = '';
            nameDisplay.textContent = '';
           statusDisplay.textContent = '';
            costInput.value = '';
            cairoCostInput.value = '';
            sahelCostInput.value = '';
            supplierInput.value = '';
             newStatusInput.value = ''; // Reset dropdown to default placeholder
            expiryInput.value = '';
           percentageInput.value = '';
           selectedItem = null; // Ensure selectedItem is cleared
       }


        function clearAll() { // This button clears inputs AND the table for "Edit Prices"
            clearInputs(); // Clears the input fields and selected item displays
            dataTableBody.innerHTML = ''; // Clears the table
        }

        function extractToExcel() {
            const headers = ['الكود', 'كود PLU (الباركود)', 'الاسم', 'الحالة الأصلية', 'التكلفة', 'القاهرة', 'الساحل', 'المورد', 'الحالة الجديدة', 'صلاحية'];
            const data = [];
             const rows = dataTableBody.querySelectorAll('tr');
           rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                // Exclude the last cell which contains the delete button for extraction
                const rowData = cells.slice(0, -1).map(cell => cell.textContent);
                 data.push(rowData);
           });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
             XLSX.writeFile(wb, 'table_data_edit_prices.xlsx');
        }


         function saveTableAsImage() {
            html2canvas(dataTable, {scale: 2, useCORS: true, logging: true}).then(canvas => { // Increased scale for better quality
                const imgData = canvas.toDataURL('image/jpeg', 0.95); // Use JPEG for smaller size, adjust quality
               const downloadLink = document.createElement('a');
                downloadLink.href = imgData;
                downloadLink.download = 'table_data_edit_prices.jpg';
                 document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            }).catch(err => {
                console.error("Error generating image: ", err);
                alert("خطأ في إنشاء الصورة. تحقق من وحدة التحكم لمزيد من التفاصيل.");
            });
        }


        function addNewItemToTable() {
           const name = newItemNameInput.value;
           const cost = newItemCostInput.value;
            const cairoCost = newItemCairoCostInput.value;
           const sahelCost = newItemSahelCostInput.value;
             const supplier = newItemSupplierInput.value;
            const expiry = newItemExpiryInput.value;
           const percentage = percentageInputNewItem.value;

            if (!name) {
                alert("الرجاء إدخال اسم الصنف.");
                return;
            }
            if(expiry && (isNaN(expiry) || expiry < 0)){
                 alert("الرجاء إدخال عدد أيام صلاحية صحيح.");
                 return;
             }

           let calculatedCairoCost = cairoCost;
           let calculatedSahelCost = sahelCost;

            if (cost && percentage) {
                const costValue = parseFloat(cost);
                const percentageValue = parseFloat(percentage) / 100;
                 if(!isNaN(costValue) && !isNaN(percentageValue) && percentageValue < 1 && percentageValue >= 0) {
                     calculatedCairoCost = (costValue / (1 - percentageValue)).toFixed(2);
                     calculatedSahelCost = (costValue / (1 - percentageValue)).toFixed(2);
                 } else if (percentageValue >= 1 || percentageValue < 0) {
                    alert("النسبة المئوية يجب أن تكون بين 0 و 99.");
                 }
            } else if (cost && !percentage) {
                calculatedCairoCost = cairoCost || '0';
                calculatedSahelCost = sahelCost || '0';
            } else if (!cost && percentage) {
                 alert("الرجاء إدخال التكلفة أولاً لتطبيق النسبة المئوية.");
                 return;
            }


           const newRow = dataTableBodyNewItem.insertRow();
           newRow.insertCell().textContent = name;
            newRow.insertCell().textContent = cost || '0';
            newRow.insertCell().textContent = calculatedCairoCost || '0';
           newRow.insertCell().textContent = calculatedSahelCost || '0';
            newRow.insertCell().textContent = supplier;
             newRow.insertCell().textContent = expiry;
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'حذف';
            deleteButton.addEventListener('click', function() {
                dataTableBodyNewItem.deleteRow(newRow.rowIndex - 1);
           });
            newRow.insertCell().appendChild(deleteButton);
            clearInputsNewItem();
        }

        function clearInputsNewItem() {
             newItemNameInput.value = '';
            newItemCostInput.value = '';
             newItemCairoCostInput.value = '';
           newItemSahelCostInput.value = '';
            newItemSupplierInput.value = '';
            newItemExpiryInput.value = '';
            percentageInputNewItem.value = '';
        }

        function extractToExcelNewItem() {
             const headers = ['الاسم', 'التكلفة', 'القاهرة', 'الساحل', 'المورد', 'صلاحية'];
             const data = [];
            const rows = dataTableBodyNewItem.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                // Exclude the last cell which contains the delete button for extraction
                const rowData = cells.slice(0, -1).map(cell => cell.textContent);
                data.push(rowData);
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            XLSX.utils.book_append_sheet(wb, ws, 'Data New Items'); // Changed sheet name slightly
             XLSX.writeFile(wb, 'table_data_new_item.xlsx');
        }

         function saveTableAsImageNewItem() {
             html2canvas(dataTableNewItem, {scale: 2, useCORS: true, logging: true}).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
               const downloadLink = document.createElement('a');
                 downloadLink.href = imgData;
                downloadLink.download = 'table_data_new_item.jpg';
                 document.body.appendChild(downloadLink);
                 downloadLink.click();
                document.body.removeChild(downloadLink);
            }).catch(err => {
                console.error("Error generating image for new items: ", err);
                alert("خطأ في إنشاء الصورة للأصناف الجديدة. تحقق من وحدة التحكم لمزيد من التفاصيل.");
            });
        }

       function clearTable() { // Button specifically for clearing the "Edit Prices" table
           dataTableBody.innerHTML = '';
        }
       function clearTableNewItem() { // Button specifically for clearing the "Add New Item" table
          dataTableBodyNewItem.innerHTML = '';
       }

       // Call fetch data on page load
       fetchDataFromGoogleSheet();

    </script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
